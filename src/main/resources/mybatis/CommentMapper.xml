<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.izanpin.repository.CommentRepository">
    <resultMap id="BaseResultMap" type="com.izanpin.entity.Comment">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="content" jdbcType="VARCHAR" property="content"/>
        <result column="author_id" jdbcType="BIGINT" property="authorId"/>
        <result column="author_name" jdbcType="VARCHAR" property="authorName"/>
        <result column="author_avatar" jdbcType="VARCHAR" property="authorAvatar"/>
        <result column="hash_id" jdbcType="VARCHAR" property="hashId"/>
        <result column="comment_count" jdbcType="INTEGER" property="commentCount"/>
        <result column="like_count" jdbcType="INTEGER" property="likeCount"/>
        <result column="hate_count" jdbcType="INTEGER" property="hateCount"/>
        <result column="type" jdbcType="INTEGER" property="type"/>
        <result column="status" jdbcType="INTEGER" property="status"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
    </resultMap>

    <resultMap id="ResultMap" type="com.izanpin.entity.Comment">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="content" jdbcType="VARCHAR" property="content"/>
        <result column="author_id" jdbcType="BIGINT" property="authorId"/>
        <result column="author_name" jdbcType="VARCHAR" property="authorName"/>
        <result column="author_avatar" jdbcType="VARCHAR" property="authorAvatar"/>
        <result column="hash_id" jdbcType="VARCHAR" property="hashId"/>
        <result column="comment_count" jdbcType="INTEGER" property="commentCount"/>
        <result column="like_count" jdbcType="INTEGER" property="likeCount"/>
        <result column="hate_count" jdbcType="INTEGER" property="hateCount"/>
        <result column="type" jdbcType="INTEGER" property="type"/>
        <result column="status" jdbcType="INTEGER" property="status"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>

        <collection property="images" ofType="com.izanpin.entity.Image">
            <id column="image_id" jdbcType="BIGINT" property="id"/>
            <result column="article_id" jdbcType="BIGINT" property="articleId"/>
            <result column="url" jdbcType="VARCHAR" property="url"/>
            <result column="thumbnail_url" jdbcType="VARCHAR" property="thumbnailUrl"/>
            <result column="image_create_time" jdbcType="TIMESTAMP" property="createTime"/>
        </collection>
    </resultMap>


    <sql id="Base_Column_List">
        id,
        content,
        author_id,
        author_name,
        author_avatar,
        hash_id,
        comment_count,
        like_count,
        hate_count,
        type,
        status,
        create_time,
        update_time
  </sql>
    <select id="findByTimeline" parameterType="com.izanpin.dto.RequestArticleTimelineDto" resultMap="ResultMap">
        select article.*,
        image.id as image_id, image.article_id, image.url, image.thumbnail_url, image.create_time as image_create_time
        from article left join image on article.id = image.article_id
        where (1=1)
        <if test="sinceId != null and sinceId != 0">
            and (article.id &gt; #{sinceId})
        </if>
        <if test="maxId != null and maxId != 0">
            and (article.id &lt; #{maxId})
        </if>
        <if test="authorId != null and authorId != 0">
            and (article.author_id = #{authorId})
        </if>
        <if test="type != null">
            and (article.type = #{type.value})
        </if>
        <if test="type != null and type.value == 0">
            and (image.id is not null)
        </if>
        <if test="type == null">
            and (article.type = 1 or (article.type = 0 and image.id is not null))
        </if>
        <if test="keyword != null">
            and (article.id = '${keyword}' or article.content like CONCAT('%','${keyword}','%'))
        </if>
        order by article.status desc, article.id desc
    </select>
    <select id="find" resultMap="ResultMap">
        select article.*,
        image.id as image_id, image.article_id, image.url, image.thumbnail_url, image.create_time as image_create_time
        from article left join image on article.id = image.article_id
        <if test="keyword != null">
            where article.id = '${keyword}' or article.content like CONCAT('%','${keyword}','%')
        </if>
        <if test="type == 0">
            and (image.id is not null)
        </if>
        order by article.status desc, article.id desc
    </select>
    <select id="findByType" resultMap="ResultMap">
        select article.*,
        image.id as image_id, image.article_id, image.url, image.thumbnail_url, image.create_time as image_create_time
        from article left join image on article.id = image.article_id
        where article.type = #{type,jdbcType=INTEGER}
        <if test="type == 0">
            and (image.id is not null)
        </if>
        <if test="keyword != null">
            and (article.id = '${keyword}' or article.content like CONCAT('%','${keyword}','%'))
        </if>
        order by article.status desc, article.id desc
    </select>
    <select id="get" parameterType="java.lang.Long" resultMap="ResultMap">
        select article.*,
        image.id as image_id, image.article_id, image.url, image.thumbnail_url, image.create_time as image_create_time
        from article left join image on article.id = image.article_id
        where article.id = #{id,jdbcType=BIGINT}
        limit 1
    </select>
    <select id="getByHashId" parameterType="java.lang.String" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from article
        where hash_id=#{hashId,jdbcType=VARCHAR}
        limit 1
    </select>
    <insert id="addComment" parameterType="com.izanpin.entity.Comment">
        INSERT INTO `comment`
        (`id`
        ,`user_id`
        ,`reply_to_id`
        ,`article_id`
        ,`number`
        ,`content`
        ,`comment_count`
        ,`like_count`
        ,`hate_count`
        ,`status`
        ,`create_time`
        ,`update_time`)
        VALUES
        (#{id}
        ,#{userId}
        ,#{replyToId}
        ,#{articleId}
        ,#{number}
        ,#{content}
        ,#{commentCount}
        ,#{likeCount}
        ,#{hateCount}
        ,#{status}
        ,#{createTime}
        ,#{updateTime})
    </insert>
    <update id="increaseCommentCount">
        update article set comment_count = comment_count + #{count}
        where id = #{id}
    </update>
</mapper>